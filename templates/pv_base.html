<!DOCTYPE html>
<html>
<head>
    <title>Pre-Validation Rules Creator</title>

    <script src="https://code.jquery.com/jquery.min.js"></script> <!-- JQUERY JS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css"> <!-- Tabler UI CSS -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}"> <!-- Favicon -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pv.css') }}"> <!-- Custom CSS for index.html page -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font.css') }}"> <!-- Inter custom font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap');

        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500;600;700&display=swap');

        /* Add some styling for the draggable icon */
        .drag-icon {
            cursor: move;
        }
        table {
            /* width: 150; */
            /* border-collapse: collapse; */
            table-layout: fixed !important; /* Ensure fixed column widths */
        }
        /* th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        } */
        th:first-child, td:first-child {
            /* Name */
            width: 45px; /* Adjust the width of the first column for the draggable icon */
        }
        th:nth-child(2), td:nth-child(2) {
            /* Name */
            width: 200px; /* Adjust the width of the first column for the draggable icon */
        }
        th:nth-child(3), td:nth-child(3) {
            /* Typep */
            width: 150px;
        }
        th:nth-child(4), td:nth-child(4) {
            /* Equation */
            width: 400px;
        }
        th:nth-child(5), td:nth-child(5) {
            /* Description */
            width: 200px;
        }
        th:nth-child(6), td:nth-child(6) {
            /* Group */
            width: 130px;
        }
        th:last-child, td:last-child {
            /* Delete button */
            width: 90px;
        }

        td:last-child {
            padding-left: 20px !important;
        }

        textarea.form-control.monospace-textarea {
            font-family: 'JetBrains Mono', monospace;
        }

        .row-index {
            font-weight: bold;
            text-align: center;
        }

        .icon {
            stroke-width: 1.7px;
        }

        .markdown>table>:not(caption)>*>*, .table>:not(caption)>*>* {
            padding: 0.75rem 0.45rem;
        }

        .swing-in-top-fwd{animation:swing-in-top-fwd .7s cubic-bezier(.175,.885,.32,1.275) both}

        /* ----------------------------------------------
        * Generated by Animista on 2023-9-14 17:9:34
        * Licensed under FreeBSD License.
        * See http://animista.net/license for more info.
        * w: http://animista.net, t: @cssanimista
        * ---------------------------------------------- */

        @keyframes swing-in-top-fwd{0%{transform:rotateX(-100deg);transform-origin:top;opacity:0}100%{transform:rotateX(0deg);transform-origin:top;opacity:1}}
    </style>
</head>

<body>
    <div class="container">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between">
                <div>
                    <h3 class="card-title">
                        <a href="{{ url_for('home') }}"><span class="badge bg-azure-lt" style="margin-right: 0.6rem; margin-bottom: 1px;">‚Üê Home</span></a>
                        <a href="{{ url_for('prevalidation') }}" style="text-decoration: none;">Pre-Validation Rules Creator</a>
                    </h3>
                </div>
                <div class="btn-list">
                    <!-- <button type="button" class="btn btn-primary" style="width: 150px;">Open existing CSV</button> -->
                    <!-- <a href="{{ url_for('open_csv') }}" class="btn btn-primary" style="width: 150px;">Open existing CSV</a> -->
                    <!-- <a href="{{ url_for('export_csv') }}" class="btn btn-success" style="width: 150px;" type="submit" form="pv-form">Export CSV</a> -->
                    <a href="{{ url_for('prevalidation') }}" class="btn" type="submit" form="pv-form">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-file-plus" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"></path>
                            <path d="M12 11l0 6"></path>
                            <path d="M9 14l6 0"></path>
                         </svg>
                        New
                    </a>
                    <span class="vr"></span>
                    <form action="{{ url_for('open_csv') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                        <input type="file" name="file" id="csvFile" accept=".csv" style="display: none;">
                        <button type="button" class="btn btn-primary" style="width: 150px;" id="uploadButton">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-upload" width="24" height="24" viewBox="0 0 24 24" stroke-width="6" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                                <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                                <path d="M7 9l5 -5l5 5"></path>
                                <path d="M12 4l0 12"></path>
                             </svg>
                            Upload CSV</button>
                    </form>

                    <button type="submit" form="pv-form" id="export-csv-button" class="btn btn-success" style="width: 150px;">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-download" width="24" height="24" viewBox="0 0 24 24" stroke-width="20" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2"></path>
                            <path d="M7 11l5 5l5 -5"></path>
                            <path d="M12 4l0 12"></path>
                         </svg>
                        Export CSV</button>
                </div>
            </div>
            <form id="pv-form" method="POST" action="/prevalidation">
                <table class="table table-vcenter" id="form-table">
                    <thead style="position: sticky;">
                        <tr>
                            <th style="text-align: center;">#</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Equation</th>
                            <th>Description</th>
                            <th>Group</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% block table_row %}{% endblock table_row %}
                    </tbody>
                </table>
            </form>


            <div class="card-footer">
                <div class="btn-list">
                    <button type="button" id="add-row" class="btn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-plus" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                            <path d="M12 5l0 14"></path>
                            <path d="M5 12l14 0"></path>
                         </svg>
                        Add more rules
                    </button>
                </div>
            </div>
        </div>
    </div>


        {% if message %}
        <div class="mt-3 alert alert-success">
            {{ message }}
        </div>
        {% endif %}

        {% if error %}
        <div class="mt-3 alert alert-important alert-dismissible wobble shadow" id="error-card">
            <i>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-exclamation-circle" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                    <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                    <path d="M12 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0"></path>
                    <path d="M12 9v4"></path>
                    <path d="M12 16v.01"></path>
                 </svg>
            </i>
            {{ error }}
            <a class="btn-close" data-bs-dismiss="alert" aria-label="close"></a>
        </div>
        {% endif %}
        </div>
    </div>

    <!-- JS to redirect to homepage if page is refreshed -->
    <!-- <script src="{{ url_for('static', filename='js/refreshPage.js') }}"></script> -->

    <!-- Tabler UI JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>

    <!-- Custom JS for showing a popup error card -->

    <script>
        let rowIndex = 1; // Initialize the row index

        // Function to update the row index based on existing rows
        function updateRowIndex() {
            const rows = document.querySelectorAll("table tbody tr");
            if (rows.length > 0) {
                rowIndex = rows.length + 1;
            } else {
                rowIndex = 1;
            }
        }

        // Call the function to set the initial rowIndex
        updateRowIndex();

        document.getElementById("add-row").addEventListener("click", function () {
            const table = document.querySelector("table tbody");
            let newRow = document.createElement("tr");
            newRow.innerHTML = `
                <td class="row-index text-muted">${rowIndex}</td>
                <td><textarea type="text" class="form-control desc" name="name[]" placeholder="Name"></textarea></td>
                <td><input type="text" class="form-control" name="type[]" placeholder="Type"></td>
                <td><textarea type="text" class="form-control monospace-textarea" name="equation[]" placeholder="Equation"></textarea></td>
                <td><textarea type="text" class="form-control desc" name="description[]" placeholder="Description"></textarea></td>
                <td><input type="text" class="form-control" name="group[]" placeholder="Group"></td>
                <td><button type="button" class="btn btn-ghost-danger delete-row badge badge-pill bg-red-lt custom-badge">Delete</button></td> <!-- Delete button -->
            `;
            newRow.classList.add('swing-in-top-fwd');
            table.appendChild(newRow);

            // Increment the row index
            rowIndex++;

            // Update row indexes for all rows
            updateRowIndex();
        });

        // Function to update row indexes for existing rows
        function updateRowIndexes() {
            const rows = document.querySelectorAll("table tbody tr");
            rows.forEach((row, index) => {
                const indexCell = row.querySelector(".row-index");
                if (indexCell) {
                    indexCell.textContent = index + 1;
                }
            });
        }

        // Add event listener to handle row deletion
        document.addEventListener("click", function (event) {
            if (event.target.classList.contains("btn-ghost-danger")) {
                const row = event.target.closest("tr");
                row.remove();
                // Recalculate row indexes after deletion
                updateRowIndexes();
                // Update the rowIndex variable
                updateRowIndex();
            }
        });

        $("textarea").each(function () {
            this.setAttribute("style", "height:" + (this.scrollHeight) + "px;overflow-y:hidden;");
        }).on("input", function () {
            this.style.height = 0;
            this.style.height = (this.scrollHeight) + "px";
        });
    </script>
    <script>
        $(document).ready(function() {
            $("#export-csv-button").click(function() {
                // First, asynchronously submit the form data
                $.post("/prevalidation", $("#pv-form").serialize())
                    .done(function() {
                        // After the form submission is successful, redirect to export CSV
                        // $("#pv-form")[0].reset();
                        window.location.href = "/export_csv";

                        setTimeout(() => {
                            window.location.href = "/prevalidation";
                        }, 500);
                    })
                    .fail(function() {
                        alert('Error submitting form');
                    });
            });
        });
    </script>
     <script>
        document.getElementById("uploadButton").addEventListener("click", function() {
            document.getElementById("csvFile").click(); // Trigger the file input
        });

        document.getElementById("csvFile").addEventListener("change", function() {
            document.getElementById("uploadForm").submit(); // Submit the form when a file is selected
        });
    </script>
</body>
</html>